// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  username     String       @unique
  passwordHash String       @map("password_hash")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  userMovies            UserMovie[]
  watchlist             Watchlist[]
  preferenceWeights     UserPreferenceWeights?
  recommendationHistory RecommendationHistory[]

  @@map("users")
}

model Movie {
  id                   String   @id @default(uuid())
  tmdbId               Int      @unique @map("tmdb_id")
  title                String
  overview             String?
  posterPath           String?  @map("poster_path")
  backdropPath         String?  @map("backdrop_path")
  releaseDate          String?  @map("release_date")
  genres               Json?
  director             String?
  directorId           Int?     @map("director_id")
  cast                 Json?    // Array of { id, name, character, profilePath }
  runtime              Int?
  tagline              String?
  keywords             Json?    // Array of { id: number, name: string }
  collectionId         Int?     @map("collection_id")
  collectionName       String?  @map("collection_name")
  productionCompanies  Json?    @map("production_companies") // Array of { id: number, name: string }
  lastUpdated          DateTime @default(now()) @map("last_updated")

  userMovies  UserMovie[]
  watchlist   Watchlist[]

  @@map("movies")
}

enum Rating {
  NOT_INTERESTED
  DISLIKE
  OK
  LIKE
  SUPER_LIKE
}

model UserMovie {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  movieId   String   @map("movie_id")
  rating    Rating
  watched   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([userId])
  @@index([movieId])
  @@index([rating])
  @@map("user_movies")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

model Watchlist {
  id       String    @id @default(uuid())
  userId   String    @map("user_id")
  movieId  String    @map("movie_id")
  addedAt  DateTime  @default(now()) @map("added_at")
  priority Priority? @default(MEDIUM)

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie    Movie     @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@index([userId])
  @@index([movieId])
  @@map("watchlist")
}

// Per-user personalized weight multipliers for recommendation scoring
model UserPreferenceWeights {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  genreWeight      Float    @default(1.0) @map("genre_weight")
  directorWeight   Float    @default(1.0) @map("director_weight")
  actorWeight      Float    @default(1.0) @map("actor_weight")
  keywordWeight    Float    @default(1.0) @map("keyword_weight")
  popularityWeight Float    @default(1.0) @map("popularity_weight")
  recencyWeight    Float    @default(1.0) @map("recency_weight")
  runtimeWeight    Float    @default(1.0) @map("runtime_weight")
  eraWeight        Float    @default(1.0) @map("era_weight")
  lastCalculated   DateTime @default(now()) @map("last_calculated")
  ratingCount      Int      @default(0) @map("rating_count") // Track ratings since last calculation

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preference_weights")
}

// Track shown recommendations to avoid repetition and enable feedback loop
model RecommendationHistory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  tmdbId      Int      @map("tmdb_id")
  shownAt     DateTime @default(now()) @map("shown_at")
  action      String?  // 'viewed', 'skipped', 'rated', 'watchlisted', 'not_interested'
  scoreAtShow Float?   @map("score_at_show") // Algorithm confidence score when shown
  ratingGiven String?  @map("rating_given")  // Rating if user rated: SUPER_LIKE, LIKE, OK, DISLIKE

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tmdbId])
  @@index([userId])
  @@index([shownAt])
  @@index([action])
  @@map("recommendation_history")
}
